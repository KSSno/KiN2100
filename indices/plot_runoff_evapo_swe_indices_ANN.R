################################################################
#
# Helga Therese Tilley Tajet, Irene Brox Nilsen og Anita Verpe Dyrrdal
# 2022-2023
#
# Kartplotting for nedbørindekser i KiN2100
#
# Modifisert av IBN 2023-01-17 for å plotte snow, avrenning og fordampning
#
# Call:
# source("plot_runoff_evapo_swe_indices_annual.R"); plotting_inds(1961, 1990, "runoff")
# source("plot_runoff_evapo_swe_indices_annual.R"); plotting_inds(1961, 1990, "swe")
# source("plot_runoff_evapo_swe_indices_annual.R"); plotting_inds(1991, 2020, "swedogn")
# source("plot_runoff_evapo_swe_indices_annual.R"); plotting_inds(1991, 2020, "evapo")
#################################################################

rm(list=ls())

library(ncdf4)
library(fields)
library(RColorBrewer)
library(plotrix)
library(raster)
library(rgdal)
# hvis de ikke finnes: install.packages("rgdal", repos="http://cran.r-project.org", type="source")

#setEPS()

#input <- "/lustre/storeB/project/KSS/kin2100_2024/Indices/Precipitation/1991-2020/"
#output <- "~/Documents/results/KIN_indicators/"

input <- c("/felles/ibni/KiN/IHA-analyser/hist/")    # fra app05 heter denne /app02-felles/, men bruk 02.
# Kopiert til app-02 fra /hdata/hmdata/KiN2100/HydMod/DistHBV/SimDistHBV/sn2018v2005/raw/pm/hist/results/runoff_1991-2020.nc
# Kopiert til app-02 fra /hdata/hmdata/KiN2100/HydMod/DistHBV/SimDistHBV/sn2018v2005/raw/pm/hist/results/evapo_1991-2020.nc
# Kopiert til app-02 fra /hdata/hmdata/KiN2100/HydMod/DistHBV/SimDistHBV/sn2018v2005/raw/pm/hist/results/swedogn_1991-2020.nc

output  <- input
maskpath  <- c("/felles/ibni/KiN/temperature_indices/senorge/")

#plotpath <- input



  #################################################################################
############################## Plotting function ####################################
  #################################################################################

plotting_inds  <- function(fra_aar, til_aar, variabel){


   # fra_aar <- 1991; til_aar <- 2020
   # fra_aar <- 1961; til_aar <- 1990
   # variabel <- "runoff"                # "evapo"  # "swe" # "swedogn"

   print("This function takes three arguments: startyear (1961 or 1991), endyear (1991 or 2020) and variable ('runoff', 'evapo', 'swe', 'swedogn'")

   if (length(args)==0) {             
       print(length(args))
       stop("At least one argument must be supplied ", call.=FALSE)
   } else if (length(args)==1) {
       if (fra_aar==1961 || fra_aar==1991) {
       }else {print("fra_aar må være 1961 eller 1991!")}
   }


    fil=paste0(variabel, "_", fra_aar, "-", til_aar, ".nc") # runoff_1991-2020.nc
    # print(fil)
    stiogfil <- paste(input,fil,sep="")
    print(paste0("Input file = ", input,fil))

    nc <- nc_open(stiogfil)
    #  indeks <- ncvar_get(nc, "tas")      # variabel
    indeks <- ncvar_get(nc, variabel)
    lat <- ncvar_get(nc, "Yc") # "lat")
    lon <- ncvar_get(nc, "Xc") # "lon")
    nc_close(nc) # må den lukkes hver gang? lukker fila, men har hentet ut swe, lat og lon

    # Norge
    stiogNorgefil <- paste(maskpath, "NorwayMaskOnSeNorgeGrid.nc", sep="")
    nc  <- nc_open(stiogNorgefil)
    #nc <- nc_open("/lustre/storeB/project/KSS/kin2100_2024/geoinfo/NorwayMaskOnSeNorgeGrid.nc")
    Norge_mask <- ncvar_get(nc,"mask")
    nc_close(nc)
    Norge_mask[is.na(Norge_mask)]=0 # setter alle NA til 0
    # mask <- ncvar_get(nc, "mask")
     
    # jeg vet ikke hva disse to linjene under gjør, kanskje de også snur kartet? (Se tre linjer ned)  - IBN
    lf <- Norge_mask
    lf[is.na(lf)] <- 0

    # raster_indeks <- raster(indeks) # for å se dimensjoner, brukes ikke videre - IBN

    nc <- nc_open(fil)
    kart_til_plot <- ncvar_get(nc,variabel)    #Dette funker, men jeg skjønner ikke hvor verdiene ligger. # Fant bare dimensjonene: YC=nc$var$runoff$dim[[1]]$vals Xc=nc$var$runoff$dim[[2]]$vals
    nc_close(nc)
                 #print("maksverdi prior to division =", max(kart_til_plot))
    kart_til_plot <- kart_til_plot/Norge_mask  # hva gjør denne? Fjerner hav og Sverige?
                 #print("maksverdi etter divisjon =", max(kart_til_plot))
    kart_til_plot <- kart_til_plot[,1550:1]



   # Fargepalett, nedbør

   base_col <- rev(c("#45508a","#406aa8","#3484c9","#1aa0ed","#6abbd8","#9cd6c1","#b5de9f","#c7e07b","#ffecbf", "#e6c991","#ccaa66")) #11 colours from blue to brown

   cols <- colorRampPalette(base_col)


   ################################# Runoff/avrenning
   if(variabel=="runoff"){ 

         rand <- c(0,5000)	# range in the original data
	 legend_tics <- c(0,500,1000,1500,2000,2500) # Hvis cols(6), bruk 6 tall
	 zlimval <- c(0,2500)   # range that you want to plot
	 legendunit <- "[mm/år]"
	 variabel_cols <- cols(length(legend_tics))   # cols(6)

	 # These data are skewed, so instead of trying to force the  legend  to cover c(0,100,1000,3000,5000), I plot all values larger than 2500 at 2501.
	 kart_til_plot[kart_til_plot>2500] <- 2501

   ################################# Evapotranspiration/fordampning
     } else if(variabel=="evapo"){

    	 rand <- c(0,500) # c(65,225)
	 legend_tics <- c(0,100,200,300,400,500)
	 zlimval <- c(0,max(legend_tics))
       	 legendunit <- "[mm/år]"
       	 variabel_cols <- cols(length(legend_tics))   # cols(6)

   ################################# Snowdays/antall snødager
     } else if(variabel=="swedogn"){

    	 rand <- c(0,365) 
	 legend_tics <- c(0,50,100,150,200,250,300,350)   #0,30,60,90,120,150,180,210)
       	 zlimval <- c(0,max(legend_tics))
       	 legendunit <- "Dager"
         col_senorge <-  rev(c("#000099", "#0019ff", "#0099ff", "#40ccff", "#80ecff", "#d9ffff", "#ccf57a"))  # senorge-paletten. Grønn til høyre.
         cols <- colorRampPalette(col_senorge)
 	 variabel_cols <- cols(length(legend_tics))   # cols(8)

   ################################# SWE/snøens vannekvivalen
     } else if(variabel=="swe"){

    	 rand <- c(-200,1500)  # range in the original data
	 legend_tics <- c(-200,0,200,400,600,800,1000)  # Hvis cols(7), bruk 7 tall
         zlimval <- c(-200,max(legend_tics))            # range you want to plot.
	 legendunit <- "mm SWE"
	 col_senorge <-  rev(c("#000099", "#0019ff", "#0099ff", "#40ccff", "#80ecff", "#d9ffff", "#ccf57a"))  # senorge-paletten. Grønn til høyre.
	 cols <- colorRampPalette(col_senorge)
	 variabel_cols <- cols(length(legend_tics))   # cols(7)
 
         # These data are skewed, so instead of trying to force the  legend  to cover a wide range, I plot all values larger than 1200 at 1201.
 	 # And to get bare ground, I plot all values exactly 0 at -1. 
	 kart_til_plot[kart_til_plot>1000] <- 1001
	 kart_til_plot[kart_til_plot==0] <- -1

   ################################# Wet days
     } else if(variabel=="wet_days"){

    	 rand <-  c(65,225)
	 legend_tics <- c(85,105,125,145,165,185,205)
       	 zlimval <- c(75,215)
	 legendunit <- "Dager"
	 #col_new <- rev(c("#3484c9","#1aa0ed","#6abbd8","#9cd6c1","#b5de9f","#c7e07b","#ffecbf","#e6c991"))
         cols <- colorRampPalette(col_new)
       	 variabel_cols <- cols(length(legend_tics))   # cols(8)

   ################################# simple_daily_intensity_index, sdii
     } else if(variabel=="simple_daily_intensity_index"){

    	 rand <-  c(0,30)
	 legend_tics <- c(5,10,15,20,25)
       	 zlimval <- c(2.5,27.5)
	 legendunit <- "[mm/dag]"
	 #col_new <- rev(c("#3484c9","#1aa0ed","#6abbd8","#b5de9f","#c7e07b","#ffecbf"))
         cols <- colorRampPalette(col_new)
       	 variabel_cols <- cols(length(legend_tics))   # cols(6)

   ################################# 99.7 percentile 
     } else if(variabel=="perc997"){

    	 rand <-  c(0,200)
	 legend_tics <- c(20,40,60,80,100,120,140,160,180)
       	 zlimval <- c(10,190)
	 legendunit <- "mm"
	 #col_new <- rev(c("#45508a","#406aa8","#3484c9","#1aa0ed","#6abbd8","#9cd6c1","#b5de9f","#c7e07b","#ffecbf",
         cols <- colorRampPalette(col_new)
	 variabel_cols <- cols(length(legend_tics))   # cols(10)

   ############################### Days with prec > 20 mm 
     } else if(variabel=="days_gt_20mm"){

    	 rand <-  c(0,100)
	 legend_tics <- c(10,20,30,40,50,60,70,80,90)
       	 zlimval <- c(5,95)
	 legendunit <- "Dager"
	 #col_new <- rev(c("#45508a","#406aa8","#3484c9","#1aa0ed","#6abbd8","#9cd6c1","#b5de9f","#c7e07b","#ffecbf","#e6c991"))
         cols <- colorRampPalette(col_new)
       	 variabel_cols <- cols(length(legend_tics))   # cols(10)

   ############################ Consecutive precipitation sum 
     } else if(variabel=="rr_max5day"){

    	 rand <-  c(0,450)
	 legend_tics <- seq(50,400,50)
       	 zlimval <- c(25,425)
	 legendunit <- "mm/5 dager"
       	 variabel_cols <- cols(length(legend_tics))   # cols(8)


   }   # end if(variabel)


   print(legend_tics)

  # nc <- nc_open(fil)
  # kart_til_plot <- ncvar_get(nc,variabel)    #Dette funker, men jeg skjønner ikke hvor verdiene ligger. # Fant bare dimensjonene: YC=nc$var$runoff$dim[[1]]$vals Xc=nc$var$runoff$dim[[2]]$vals
  # nc_close(nc)
  #               #print("maksverdi prior to division =", max(kart_til_plot))
  # kart_til_plot <- kart_til_plot/Norge_mask  # hva gjør denne? Fjerner hav og Sverige?
  #               #print("maksverdi etter divisjon =", max(kart_til_plot))
  # kart_til_plot <- kart_til_plot[,1550:1]


   png(paste0(output,"map_30yr_mean_", variabel, "_", fra_aar, "-", til_aar, "_ANN.png"), width=2000, height=2500, pointsize=20,res=300)
	par(mar=c(0.5,0.2,0,0.3))

	image(kart_til_plot, xlab="",ylab="",xaxt="n",yaxt="n",zlim=rand,col=variabel_cols,bty="n")
	contour(lf[,1550:1],add=T,levels = 0.5,drawlabels = FALSE,lwd=1,col="grey20")
	image.plot(kart_til_plot, legend.lab="",legend.line=2.7,axis.args=list(tick=FALSE,at=legend_tics),  
           legend.shrink=0.6,legend.only = TRUE,zlim=zlimval,col=variabel_cols,smallplot=c(0.7,0.75,0.1,0.6))
	text(0.77,0.63, legendunit, font=1)

   dev.off()

   print(paste0("Plotting is done. Now check your recently generated file ", output, "map_30yr_mean_", variabel, "_", fra_aar, "-", til_aar, "_ANN.png"))

} # End function plotting_inds
